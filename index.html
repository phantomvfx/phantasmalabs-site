<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="description" content="Phantasma Labs">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phantasma Labs</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Muli&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js"></script>

  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #000;
      color: white;
      overflow: hidden;
    }

    a {
      color: white;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    a:hover {
      color: orange;
    }

    #pixi-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
    }

    /* Hide the original video element */
    #backgroundVideo {
      display: none;
    }
  </style>
</head>

<body>

  <!-- PIXI Canvas -->
  <canvas id="pixi-canvas"></canvas>

  <!-- Video Element -->
  <video id="backgroundVideo" autoplay muted loop playsinline>
    <source src="clips/004_web.mp4?v=202506142043" type="video/mp4">
  </video>

  <!-- Navigation -->
  <div style="max-width: 320px; margin: 10px 0; text-align: left; padding: 1px; border-radius: 10px; position: relative; z-index: 2;">
    <h4 style="margin-bottom: 20px; color: white;">Phantasma Labs</h4>
    <a href="synthography.html">Synthography</a>
  </div>

  <div style="position: fixed; bottom: 20px; left: 20px; text-align: left; z-index: 2;">
    <a href="mailto:mail@phantasmalabs.com" style="color: white; font-size: 24px;">
      <i class="fas fa-envelope"></i>
    </a>
  </div>

  <!-- Main Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // CONFIGURATION
      const fallbackImageURL = 'clips/001.png'; // Your fallback image
      const distortionImageURL = 'images/distortion.png'; // Your distortion map
      
      const videoElement = document.getElementById('backgroundVideo');
      const canvasElement = document.getElementById('pixi-canvas');

      let app;
      let backgroundSprite;
      let displacementSprite;
      let isInitialized = false;

      // 1. Initialize Pixi with a specific source (Video Element OR Image URL)
      function initPixi(sourceType, source) {
        if (isInitialized) return;
        isInitialized = true;

        console.log(`Initializing Pixi with: ${sourceType}`);

        // Create Application
        app = new PIXI.Application({
          view: canvasElement,
          resizeTo: window,
          backgroundAlpha: 0,
          backgroundColor: 0x000000
        });

        // Create Background Texture
        let bgTexture;
        if (sourceType === 'video') {
           bgTexture = PIXI.Texture.from(source);
        } else {
           bgTexture = PIXI.Texture.from(source);
        }

        backgroundSprite = new PIXI.Sprite(bgTexture);
        backgroundSprite.anchor.set(0);
        app.stage.addChild(backgroundSprite);

        // Load Distortion Filter
        const distortionTexture = PIXI.Texture.from(distortionImageURL);
        displacementSprite = new PIXI.Sprite(distortionTexture);
        displacementSprite.texture.baseTexture.wrapMode = PIXI.WRAP_MODES.REPEAT;
        displacementSprite.anchor.set(0.5);
        displacementSprite.scale.set(10);
        
        // Center the filter
        displacementSprite.x = app.screen.width / 2;
        displacementSprite.y = app.screen.height / 2;

        app.stage.addChild(displacementSprite);

        const displacementFilter = new PIXI.filters.DisplacementFilter(displacementSprite);
        app.stage.filters = [displacementFilter];

        // Add resize listener
        window.addEventListener('resize', resizeBackground);
        
        // Add animation loop
        app.ticker.add(() => {
          displacementSprite.rotation += 0.002;
        });

        // Trigger initial resize
        // We wait a tiny bit for texture to load dimensions
        if (sourceType === 'image') {
           bgTexture.baseTexture.once('loaded', resizeBackground);
        }
        resizeBackground();
      }

      // 2. Resize Function (Works for both Image and Video)
      function resizeBackground() {
        if (!backgroundSprite || !app) return;

        const screenWidth = app.screen.width;
        const screenHeight = app.screen.height;
        
        // Get natural dimensions of the texture
        const texture = backgroundSprite.texture;
        if (!texture.valid) return; // Wait for texture to be valid

        const texWidth = texture.width;
        const texHeight = texture.height;

        if (texWidth === 0 || texHeight === 0) return;

        const texAspectRatio = texWidth / texHeight;
        const screenAspectRatio = screenWidth / screenHeight;

        let scale, newWidth, newHeight, offsetX = 0, offsetY = 0;

        // Cover logic (CSS background-size: cover equivalent)
        if (texAspectRatio > screenAspectRatio) {
          scale = screenHeight / texHeight;
          newWidth = texWidth * scale;
          newHeight = screenHeight;
          offsetX = (screenWidth - newWidth) / 2;
        } else {
          scale = screenWidth / texWidth;
          newWidth = screenWidth;
          newHeight = texHeight * scale;
          offsetY = (screenHeight - newHeight) / 2;
        }

        backgroundSprite.width = newWidth;
        backgroundSprite.height = newHeight;
        backgroundSprite.x = offsetX;
        backgroundSprite.y = offsetY;

        if (displacementSprite) {
            displacementSprite.x = screenWidth / 2;
            displacementSprite.y = screenHeight / 2;
        }
      }

      // 3. Loading Logic (The "Race" between Video and Timeout)
      
      // If video element is missing, go straight to image
      if (!videoElement) {
        console.warn("Video element not found. Using fallback image.");
        initPixi('image', fallbackImageURL);
        return;
      }

      // Set playback rate safely
      videoElement.playbackRate = 0.5;

      // Timer: If video takes longer than 3 seconds, load image
      const fallbackTimer = setTimeout(() => {
        if (!isInitialized) {
          console.warn("Video loading timed out. Switching to fallback image.");
          initPixi('image', fallbackImageURL);
        }
      }, 3000); // 3000ms = 3 seconds

      // Try to play video
      const startVideo = () => {
        if (!isInitialized) {
          clearTimeout(fallbackTimer); // Stop the timer, video won!
          initPixi('video', videoElement);
          videoElement.play().catch(e => console.error("Video play blocked:", e));
        }
      };

      if (videoElement.readyState >= 2) {
        startVideo();
      } else {
        videoElement.addEventListener('loadeddata', startVideo);
        videoElement.addEventListener('error', () => {
           console.warn("Video error detected. Switching to fallback image.");
           clearTimeout(fallbackTimer);
           initPixi('image', fallbackImageURL);
        });
        videoElement.load();
      }

    });
  </script>
</body>
</html>